<?php
$form->setAttribute('action', $this->url('cong_viec/crud', array('action'=>'giao-viec')));
$form->prepare();?>

<?php
echo $this->form()->openTag($form);
$congViec = $form->get('congViec');
$congVan = $congViec->get('cha');?>
<div class="ui form">
	<div class="ui celled grid">
		<!-- <div class="row">
			<div class="eight wide column">
				<h2 class="ui header"><span><i class="plus icon"></i></span> GIAO VIỆC MỚI</h2>
			</div>
		</div> -->
		<div class="row">
			<div class="ten wide column">
				<?php $user =  $this->zfcUserIdentity();?>
				<?php $nguoiTao = $congViec->get('nguoiTao'); ?>
				<?php $nguoiTao->setAttribute('value', $user->getId()) ?>
				<?php echo $this->formHidden($nguoiTao); ?>
				<div class="two fields">
					<div class="field">
						<?php echo $this->formLabel($congViec->get('loai')); ?>
			          	<?php echo $this->formElement($congViec->get('loai')); ?>
			          	<?php echo $this->formElementErrors($congViec->get('loai')); ?>
					</div>
					<div class="field">
						<?php echo $this->formLabel($congViec->get('linhVuc')); ?>
			          	<?php echo $this->formElement($congViec->get('linhVuc')); ?>
			          	<?php echo $this->formElementErrors($congViec->get('linhVuc')); ?>
			        </div>
				</div>
				<div class="field reset able">
					<?php echo $this->formLabel($congViec->get('ten')); ?>
		          	<?php echo $this->formElement($congViec->get('ten')); ?>
		          	<?php echo $this->formElementErrors($congViec->get('ten')); ?>
				</div>
				<div class="two fields">
					<div class="field">
						<?php echo $this->formLabel($congViec->get('ngayBanHanh')); ?>
			          	<?php echo $this->formJqxDate($congViec->get('ngayBanHanh')); ?>
			          	<?php echo $this->formElementErrors($congViec->get('ngayBanHanh')); ?>
					</div>
					<div class="field">
						<?php echo $this->formLabel($congViec->get('ngayHoanThanh')); ?>
			          	<?php echo $this->formJqxDate($congViec->get('ngayHoanThanh')); ?>
			          	<?php echo $this->formElementErrors($congViec->get('ngayHoanThanh')); ?>
					</div>
				</div>
				<div class="field reset able">
					<?php echo $this->formLabel($congViec->get('noiDung')); ?>
		          	<?php echo $this->formElement($congViec->get('noiDung')); ?>
		          	<?php echo $this->formElementErrors($congViec->get('noiDung')); ?>
				</div>			
			</div>
			<div class="six wide column">
				<?php echo $this->formHidden($congVan->get('id')); ?>
				<div class="field">
					<?php echo $this->formLabel($congVan->get('soHieu')); ?>
		          	<?php echo $this->formElement($congVan->get('soHieu')); ?>
		          	<?php echo $this->formElementErrors($congVan->get('soHieu')); ?>
				</div>
				<div class="field">
					<?php echo $this->formLabel($congVan->get('ngayBanHanh')); ?>
		          	<?php echo $this->formJqxDate($congVan->get('ngayBanHanh')); ?>
		          	<?php echo $this->formElementErrors($congVan->get('ngayBanHanh')); ?>
				</div>
				<div class="field">
					<?php echo $this->formLabel($congVan->get('nguoiKy')); ?>
		          	<?php echo $this->formElement($congVan->get('nguoiKy')); ?>
		          	<?php echo $this->formElementErrors($congVan->get('nguoiKy')); ?>
				</div>
				<div class="field">
					<?php echo $this->formLabel($congVan->get('trichYeu')); ?>
		          	<?php echo $this->formElement($congVan->get('trichYeu')); ?>
		          	<?php echo $this->formElementErrors($congVan->get('trichYeu')); ?>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="eight wide column">
				<div class="field reset able">
					<?php echo $this->formLabel($congViec->get('dinhKems')); ?>
		          	<?php echo $this->formElement($congViec->get('dinhKems')); ?>
		          	<?php echo $this->formElementErrors($congViec->get('dinhKems')); ?>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="eight wide column">
				<div class="field">
					<label>Thực hiện</label>
					<div class="jstree"></div>
				</div>
			</div>
			<div class="eight wide column">
				<div class="field">
					<label>Phân công <i id="phan_lai" class="circular undo link icon" title="Phân công lại"></i></label>
					<?php $nguoiThucHiens = $congViec->get('nguoiThucHiens'); ?>
					<div id="event_result">
						<?php echo $this->formCollection($nguoiThucHiens); ?>
						<div class="template ui hidden">
						    <?php echo $this->vaiTro(); ?>
						    <!-- <img class="ui avatar image" src="<?php echo $this->basePath();?>/img/square-image.png"> -->
						    <div class="content">
						     	__ten__
						    </div>
						</div>
						<div class="ui list divided"></div>
					</div>
				</div>
			</div>
		</div>
			
		<div class="row">
			<div class="sixteen wide column">
				<div class="field">
					<div class="ui checkbox">
				      	<input type="checkbox">
				      	<label>Công việc khẩn</label>
				    </div>
				</div>
				<div class="field">
					<?php echo $this->formSubmit($form->get('submit')); ?>
				</div>
			</div>
			<?php echo $this->formHidden($form->get('csrf')); ?>
			<?php echo $this->form()->closeTag();?>
		</div>
	</div>
</div>
<script type="text/javascript">
	$('.jstree').jstree({
		'core' : {
			'data' : {
				"url" : "<?php echo $this->url('cong_viec/crud', array('action'=>'ajax-get-to-chuc')) ?>",
				"dataType" : "json" // needed only if you do not supply JSON headers
			}
		}
	}).bind("dblclick.jstree", function (event) {
	   var node = $(event.target).closest("li");
	   var id = node.attr('id');
	   var ten = node.text();
	   if(isNaN(id)){
	   	alert('Vui lòng chọn nhân viên để phân công');
	   }
	   else{
	   	var currentCount = add_phan_cong();
	   	var template = $('#event_result .template').html();
	   	template = template.replace(/__ten__/g, ten);
	   	$('#event_result .list').append('<div id="pc_'+currentCount+'" class="item">' + template + '</div>');
	   	$('input[name="cong-van[congViecs][0][nguoiThucHiens]['+currentCount+'][vaiTro]"]').val(<?php echo \CongViec\Entity\PhanCong::PHOI_HOP; ?>);
	   	$('input[name="cong-van[congViecs][0][nguoiThucHiens]['+currentCount+'][nguoiThucHien][id]"]').val(id);
	   	$('#pc_'+currentCount+' .ui.dropdown')
	        .dropdown({
	        	onChange: function (val) {
	        		if(!isNaN(val)){
	        			$('input[name="cong-van[congViecs][0][nguoiThucHiens]['+currentCount+'][vaiTro]"]').val(val);
	        		}
			    }
	        })
	      ;
	   	/*$.ajax({
	   		type : 'post',
	   		dataType : 'json',
	   		data : {
	   			'id' : id,
	   		},
	   		url : "<?php echo $this->url('cong_viec/crud', array('action'=>'ajax-get-nhan-vien')) ?>",
	   		success : function(data){
	   			alert(data.id);
	   		}
	   	});*/
	   }
	});

	$('#phan_lai').click(function(){
		$('#event_result > .list').empty();
		$('#event_result > fieldset > fieldset').remove();
	});


	$('.reset.able :input')
	 	.val('')
	 	.removeAttr('checked')
	 	.removeAttr('selected');
	

	function add_phan_cong() {
        var currentCount = $('#event_result > fieldset > fieldset').length;
        var template = $('#event_result > fieldset > span').data('template');
        template = template.replace(/__index__/g, currentCount);

        $('#event_result > fieldset').prepend(template);

        return currentCount;
    }
</script>